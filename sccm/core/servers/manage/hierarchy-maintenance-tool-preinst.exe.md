---
title: "階層のメンテナンス ツール | Microsoft Docs"
description: "階層のメンテナンス メールでできることとそれを利用する理由について説明します。 コマンド ライン オプションの参照が含まれています。"
ms.custom: na
ms.date: 10/06/2016
ms.prod: configuration-manager
ms.reviewer: na
ms.suite: na
ms.technology: configmgr-other
ms.tgt_pltfrm: na
ms.topic: article
ms.assetid: cead6825-6113-4ba5-a381-ac3598dfee86
caps.latest.revision: "7"
caps.handback.revision: "0"
author: Brenduns
ms.author: brenduns
manager: angrobe
ms.openlocfilehash: f3ddeaadfb1418aeeaacdca47768600c86b59083
ms.sourcegitcommit: 51fc48fb023f1e8d995c6c4eacfda7dbec4d0b2f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/07/2017
---
# <a name="hierarchy-maintenance-tool-preinstexe-for-system-center-configuration-manager"></a>System Center Configuration Manager の階層のメンテナンス ツール (Preinst.exe)

*適用対象: System Center Configuration Manager (Current Branch)*

階層のメンテナンス ツール (Preinst.exe) は、階層マネージャー サービスの実行中に System Center Configuration Manager 階層マネージャーにコマンドを渡します。 階層のメンテナンス ツールは、Configuration Manager サイトのインストール時に自動的にインストールされます。 Preinst.exe は、サイト サーバー上の \\&lt;*SiteServerName*>\SMS_&lt;*SiteCode*\bin\X64\00000409 共有フォルダーに格納されています。  

 次のような場合に、階層のメンテナンス ツールを使用します。  

-   セキュリティ キーの交換が必要とされ、サイト間で初期公開キーを手動で交換しなければならない場合。 詳細については、このトピックの「 [サイト間で公開キーを手動で交換する](#BKMK_ManuallyExchangeKeys) 」をご覧ください。  

-   現在は利用できなくなったターゲット サイト用のアクティブ ジョブを削除する場合。  

-   セットアップを使用してサイトをアンインストールできないときに、Configuration Manager コンソールからサイト サーバーを削除する場合。 たとえば、最初にセットアップを実行してサイトをアンインストールせずに、物理的に Configuration Manager サイトを削除した場合、サイト情報は親サイトのデータベース内に残ったままになり、親サイトは引き続き子サイトとの通信を試行します。 この問題を解決するには、階層のメンテナンス ツールを実行して、親サイトのデータベースから子サイトを手動で削除します。  

-   サービスを個別に停止せずに、サイトのすべての Configuration Manager サービスを停止する場合。  

-   サイトの回復を行っている場合は、CHILDKEYS オプションを使用して、回復しているサイトに複数の子サイトの公開キーを配布できます。  

階層のメンテナンス ツールを実行するには、現在のユーザーがローカル コンピューターに対する管理者特権を持っている必要があります。 また、現在のユーザーには、サイトの管理者セキュリティ権限が明示的に与えられている必要があります。現在のユーザーがそのアクセス許可を持つグループのメンバーであることによってこの権限を継承しているのでは不十分です。  

## <a name="hierarchy-maintenance-tool-command-line-options"></a>階層のメンテナンス ツールのコマンドライン オプション  
階層のメンテナンス ツールを使用する際には、中央管理サイト、プライマリ サイト、またはセカンダリ サイト サーバーでローカルに実行する必要があります。  

階層のメンテナンス ツールの実行時には、preinst.exe /&lt;オプション\> という構文を使用する必要があります。 コマンド ライン オプションは以下のとおりです。  

 **/DELJOB &lt;*SiteCode*>** - このオプションをサイトで使用して、現在のサイトから指定のターゲット サイトに対するすべてのジョブまたはコマンドを削除します。  

 **/DELSITE &lt;*ChildSiteCodeToRemove*>** - このオプションを親サイトで使用して、親サイトのサイト データベースから子サイトのデータを削除します。 通常、サイト サーバー コンピューターからサイトをアンインストールする前に使用停止とされた場合に、このオプションを使用します。  

> [!NOTE]  
>  /DELSITE オプションでは、ChildSiteCodeToRemove パラメーターで指定されたコンピューター上のサイトはアンインストールされません。 このオプションは、サイト情報を Configuration Manager サイト データベースから削除するだけです。  

**/DUMP &lt;*SiteCode*>** - ローカル サイト サーバーでこのオプションを使用して、サイトがインストールされているドライブのルート フォルダーにサイト コントロール イメージを書き込みます。 特定のサイト コントロール イメージをフォルダーに書き込むか、階層内のすべてのサイト コントロール ファイルを書き込むことができます。  

-   /DUMP &lt;*SiteCode*> は、指定されたサイトについてのみサイト コントロール イメージを書き込みます。  

-   /DUMP は、すべてのサイトのサイト コントロール ファイルを書き込みます。  

イメージとは、サイト コントロール ファイルのバイナリ表現であり、Configuration Manager サイト データベースに格納されています。 ダンプされたサイト コントロール ファイル イメージは、基本イメージと保留中のデルタ イメージを組み合わせたものです。  

階層のメンテナンス ツールを使用してサイト コントロール ファイル イメージをダンプすると、sitectrl_&lt;*SiteCode*>.ct0 という形式のファイル名になります。  

**/STOPSITE** - ローカル サイト サーバーでこのオプションを使用して、Configuration Manager サイト コンポーネント マネージャー サービスのシャットダウン サイクルを開始します。これにより、サイトが部分的にリセットされます。 このシャットダウン サイクルの実行時に、サイト サーバーの一部の Configuration Manager サービスとそのリモート サイト システムが停止します。 これらのサービスには、再インストールのフラグが付けられます。 シャットダウン サイクルの実行の結果、サービスの再インストール時に一部のパスワードが自動的に変更されます。  

> [!NOTE]  
>  サイト コンポーネント マネージャーのシャットダウン、再インストール、およびパスワード変更の記録を参照するには、このコマンド ライン オプションを使用する前にこのコンポーネントのログを有効にします。  

シャットダウン サイクルの開始後は、自動的に処理が行われ、応答していないコンポーネントやコンピューターはスキップされます。 ただし、シャットダウン サイクル中にサイト コンポーネント マネージャー サービスからリモート サイト システムにアクセスできない場合は、サイト コンポーネント マネージャー サービスの再起動時に、リモート サイト システムにインストールされているコンポーネントが再インストールされます。 サイト コンポーネント マネージャー サービスは、再起動すると、再インストールのフラグが付いているすべてのサービスの再インストールが完了するまで、再インストールを繰り返し試行します。  

サイト コンポーネント マネージャー サービスはサービス マネージャーを使用して再起動できます。 再起動後に、影響を受けたすべてのサービスのアンインストール、再インストール、および再起動が行われます。 /STOPSITE オプションを使用してシャットダウン サイクルを開始した後に、サイト コンポーネント マネージャー サービスの再起動後、再インストール サイクルを回避することはできません。  

**/KEYFORPARENT** - このオプションをサイトで使用して、サイトの公開キーを親サイトに配布します。  

/KEYFORPARENT オプションは、サイトの公開キーをプログラム ファイル ドライブのルートにある &lt;*SiteCode*>.CT4 ファイルに保存します。 このオプションを使用して preinst.exe を実行した後で、&lt;*SiteCode*>.CT4 ファイルを親サイトの ...\Inboxes\hman.box フォルダーに手動でコピーしてください。コピー先は hman.box\pubkey ではありません。  

**/KEYFORCHILD** - このオプションをサイトで使用して、サイトの公開キーを子サイトに配布します。  

/KEYFORCHILD オプションは、サイトの公開キーをプログラム ファイル ドライブのルートにある &lt;*SiteCode*>.CT5 ファイルに保存します。 このオプションを使用して preinst.exe を実行した後で、&lt;*SiteCode*>.CT5 ファイルを子サイトの ...\Inboxes\hman.box フォルダーに手動でコピーしてください。コピー先は hman.box\pubkey ではありません。  

**/CHILDKEYS** - 回復中のサイトの子サイトでこのオプションを使用できます。 このオプションを使用して、複数の子サイトから回復サイトに公開キーを配布できます。  

/CHILDKEYS オプションは、オプションの実行元のサイトのキーと、そのサイトのすべての子サイトの公開キーを &lt;*SiteCode*>.CT6 ファイルに保存します。  

このオプションを使用して preinst.exe を実行した後で、&lt;*SiteCode*>.CT6 ファイルを回復サイトの ...\Inboxes\hman.box フォルダーに手動でコピーしてください。コピー先は hman.box\pubkey ではありません。  

**/PARENTKEYS** - 回復サイトの親サイトでこのオプションを使用できます。 このオプションを使用して、すべての親サイトから回復中のサイトに公開キーを配布できます。  

/PARENTKEYS オプションは、オプションの実行元のサイトのキーと、そのサイトの上位にある各親サイトのキーを &lt;SiteCode\>.CT7 ファイルに保存します。  

このオプションを使用して preinst.exe を実行した後で、&lt;*SiteCode*>.CT7 ファイルを回復サイトの ...\Inboxes\hman.box フォルダーに手動でコピーしてください。コピー先は hman.box\pubkey ではありません。  

##  <a name="BKMK_ManuallyExchangeKeys"></a> サイト間で公開キーを手動で交換する  
既定で、Configuration Manager サイトでは **[セキュリティで保護されているキーの交換を必要とする]** オプションが有効になっています。 セキュリティ キーの交換が必要な場合、次の 2 つのケースで、サイト間の初期キー交換を手動で行う必要があります。  

-   Active Directory スキーマを Configuration Manager 用に拡張していない場合  

-   Configuration Manager サイトがサイト データを Active Directory に発行していない  

階層のメンテナンス ツールを使用して、各サイトの公開キーをエクスポートできます。 公開キーのエクスポート後、サイト間でキーを手動で交換する必要があります。  

> [!NOTE]  
>  公開キーを手動で交換した後で、サイト構成の変更やサイト情報の Active Directory ドメイン サービスへの発行が記録される **hman.log** ログ ファイルを親サイト サーバーで表示し、プライマリ サイトで新しい公開キーが処理されたことを確認できます。  

#### <a name="to-manually-transfer-the-child-site-public-key-to-the-parent-site"></a>子サイトの公開キーを親サイトに手動で転送するには  

1.  子サイトにログオンしている状態で、コマンド プロンプトを開き、 **Preinst.exe**がある場所に移動します。  

2.  次のように入力して、子サイトの公開キーをエクスポートします。 **Preinst /keyforparent**  

3.  /keyforparent オプションは、子サイトの公開キーをシステム ドライブのルートにある **&lt;site code\>.CT4** ファイルに保存します。  

4.  **&lt;site code\>.CT4** ファイルを、親サイトの **&lt;インストール ディレクトリ\>\inboxes\hman.box** フォルダーに移動します。  

#### <a name="to-manually-transfer-the-parent-site-public-key-to-the-child-site"></a>親サイトの公開キーを子サイトに手動で転送するには  

1.  親サイトにログオンしている状態で、コマンド プロンプトを開き、 **Preinst.exe**がある場所に移動します。  

2.  「**Preinst /keyforchild**」と入力して、親サイトの公開キーをエクスポートします。  

3.  /keyforchild オプションは、親サイトの公開キーをシステム ドライブのルートにある **&lt;site code\>.CT5** ファイルに保存します。  

4.  **&lt;site code\>.CT5** ファイルを、子サイトの **&lt;インストール ディレクトリ\>\inboxes\hman.box** ディレクトリに移動します。  
