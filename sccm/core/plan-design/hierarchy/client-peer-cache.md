---
title: クライアントのピア キャッシュ
titleSuffix: Configuration Manager
description: Configuration Manager でコンテンツを展開するときに、ソースの場所としてクライアントのピア キャッシュを使用します。
ms.date: 09/19/2018
ms.prod: configuration-manager
ms.technology: configmgr-other
ms.topic: conceptual
ms.assetid: 86cd5382-8b41-45db-a4f0-16265ae22657
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.openlocfilehash: 0650e1aa16f0c1005748c85423c3367a727b1b9b
ms.sourcegitcommit: 4659946369d5352234f27c7682bce65a0e86c697
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/12/2018
ms.locfileid: "53303892"
---
# <a name="peer-cache-for-configuration-manager-clients"></a>構成マネージャー クライアントのピア キャッシュ

「オブジェクトの*適用対象: System Center Configuration Manager (Current Branch)*

<!--1101436--> ピア キャッシュを使用すると、リモートの場所にあるクライアントへのコンテンツの展開を管理するのに役立ちます。 ピア キャッシュとは、クライアントがローカル キャッシュで他のクライアントとコンテンツを直接共有できるようにするための組み込みの Configuration Manager ソリューションです。   

> [!Note]  
> Configuration Manager では、このオプション機能は既定で無効です。 この機能は、使用する前に有効にする必要があります。 詳細については、「[更新プログラムのオプション機能の有効化](/sccm/core/servers/manage/install-in-console-updates#bkmk_options)」を参照してください。<!--505213-->  



## <a name="overview"></a>概要

定義:  

- **ピア キャッシュ クライアント**:ピアからコンテンツをダウンロードする任意の構成マネージャー クライアント  

- **ピア キャッシュ ソース**:ユーザーによってピア キャッシュを有効にされ、他のクライアントと共有するコンテンツを保持している構成マネージャー クライアント  

クライアントの設定を使用して、ピア キャッシュ ソースとしてクライアントを有効にします。 ピア キャッシュ クライアントを有効にする必要はありません。 ピア キャッシュ ソースとしてクライアントを有効にすると、管理ポイントによってコンテンツの場所のソースの一覧にクライアントが追加されます。<!--510397--> この処理について詳しくは、「[オペレーション](#operations)」をご覧ください。  

ピア キャッシュ ソースは、ピア キャッシュ クライアントの現在の境界グループのメンバーである必要があります。 管理ポイントがクライアントを提供するコンテンツのソースの一覧に、近隣境界グループのピア キャッシュ ソースが含まれることはありません。 近隣境界グループの配布ポイントのみが含まれます。 現在および近隣の境界グループについて詳しくは、[境界グループ](/sccm/core/servers/deploy/configure/define-site-boundaries-and-boundary-groups##a-namebkmkboundarygroupsa-boundary-groups)に関するページをご覧ください。<!--SCCMDocs issue 685-->  

構成マネージャー クライアントは、ピア キャッシュを使用して、キャッシュ内のすべての種類のコンテンツを、他のクライアントに提供します。 このコンテンツには、Office 365 ファイルおよび高速インストール ファイルが含まれます。<!--SMS.500850-->  

ピア キャッシュによって、Windows BranchCache や配信の最適化などの他のソリューションが置き換えられることはありません。 ピア キャッシュは、他のソリューションと共に動作します。 これらのテクノロジにより、配布ポイントなどの従来のコンテンツ展開ソリューションを拡張するオプションが提供されます。 ピア キャッシュは、BranchCache に依存しないカスタム ソリューションです。 BranchCache を有効にしていない場合または使用していない場合でも、ピア キャッシュは正常に動作します。  

  > [!Note]  
  > バージョン 1802 以降では、Windows BranchCache は常に展開で有効になります。 **[同じサブネットにある他のクライアントとのコンテンツの共有を許可する]** の設定は削除されます。<!--SCCMDocs issue 539--> BranchCache が配布ポイントでサポートされていて、クライアントの設定で有効になっている場合、クライアントは BranchCache を使用します。 詳しくは、「[BranchCache の構成](/sccm/core/clients/deploy/about-client-settings#configure-branchcache)」をご覧ください。<!--SCCMDocs issue 735-->   



## <a name="operations"></a>オペレーション

ピア キャッシュを有効にするには、[クライアント設定](#bkmk_settings)をコレクションに展開します。 すると、そのコレクションのメンバーは、同じ境界グループ内の他のクライアント用のピア キャッシュ ソースとして機能します。  

 -  ピア コンテンツ ソースとして動作するクライアントは、キャッシュされている利用可能なコンテンツの一覧を管理ポイントに送信します。  

 -  同じ境界グループ内の別のクライアントは、管理ポイントに対してコンテンツの場所を要求します。 サーバーは、潜在的なコンテンツ ソースの一覧を返します。 この一覧には、コンテンツがあり、オンラインになっている各ピア キャッシュ ソースが含まれます。 また、その境界グループにおける配布ポイントやその他のコンテンツ ソースの場所も含まれます。 詳しくは、「[コンテンツ ソースの優先順位](/sccm/core/plan-design/hierarchy/fundamental-concepts-for-content-management#content-source-priority)」をご覧ください。  

 -  通常どおり、コンテンツをシークしているクライアントは、指定されたリストから 1 つのソースを選択します。 次にクライアントは、コンテンツの取得を試みます。  

バージョン 1806 以降では、環境内のコンテンツ配布をより細かく制御できるように、境界グループに追加の設定が設けられました。 詳細については、「[ピアのダウンロードの境界グループのオプション](/sccm/core/servers/deploy/configure/boundary-groups#bkmk_bgoptions)」を参照してください。<!--1356193-->

> [!NOTE]  
> コンテンツの近隣境界グループへのフォールバックがクライアントによって行われる場合、管理ポイントは、近隣境界グループからのピア キャッシュ ソースを、潜在的なコンテンツ ソースの場所の一覧に追加しません。  

ピア キャッシュ ソースとして最適なクライアントのみを選択します。 シャーシの種類、ディスク容量、ネットワーク接続などの属性に基づいてクライアントの適合性を評価します。 ピア キャッシュで使用する最適なクライアントを選択するのに役立つ詳細については、[Microsoft のコンサルタントによる、このブログ](https://blogs.technet.microsoft.com/askpfeplat/2018/11/21/configuration-manager-peer-cache-custom-reporting-examples/)を参照してください。


### <a name="limited-access-to-a-peer-cache-source"></a>ピア キャッシュ ソースへのアクセス制限  

ピア キャッシュ ソースは、ピアによるコンテンツの要求が次の条件のいずれかを満たす場合、コンテンツの要求を拒否します。  

  -  バッテリ低下モードである  

  -  プロセッサの負荷が 80% を超えている  

  -  ディスク I/O に 10 を超える *AvgDiskQueueLength* がある  

  -  コンピューターへの使用可能な接続がそれ以上ない  

> [!Tip]  
> これらの設定は、Configuration Manager SDK のピア ソース機能 (*SMS_WinPEPeerCacheConfig*) のクライアント構成サーバー WMI クラスを使って構成します。  

ピア キャッシュ ソースがコンテンツの要求を拒否すると、ピア キャッシュ クライアントは、コンテンツ ソースの場所の一覧でコンテンツを引き続きシークします。   



## <a name="requirements"></a>［要件］

- ピア キャッシュは、[クライアントとデバイスのサポートされるオペレーティング システム](/sccm/core/plan-design/configs/supported-operating-systems-for-clients-and-devices)に関するページでサポート対象として記載されているすべてのバージョンの Windows をサポートします。 Windows 以外のオペレーティング システムは、ピア キャッシュ ソースまたはピア キャッシュ クライアントとしてサポートされていません。  

- ピア キャッシュ ソースは、ドメインに参加している構成マネージャー クライアントである必要があります。 ただし、ドメインに参加していないクライアントでも、ドメインに参加しているピア キャッシュ ソースからコンテンツを取得できます。  

- クライアントは、同じ現在の境界グループ内にあるピア キャッシュ ソースのコンテンツのみをダウンロードできます。  

- 次の例外を除き、[ネットワーク アクセス アカウント](/sccm/core/plan-design/hierarchy/accounts#network-access-account)は必要ありません。  

    - ピア キャッシュ対応のクライアントがソフトウェア センターからタスク シーケンスを実行し、そのタスク シーケンスがブート イメージで再起動する場合は、サイトでネットワーク アクセス アカウントを構成します。 Windows PE のデバイスは、ネットワーク アクセス アカウントを使用してピア キャッシュ ソースからコンテンツを取得します。  

    - 必要に応じて、ピア キャッシュ ソースはピアからのダウンロード要求を認証するためにネットワーク アクセス アカウントを使用します。 このような目的でこのアカウントを使用する場合はドメイン ユーザーのアクセス許可のみが必要です。  

- バージョン 1802 以前の場合、クライアントの最後の定期探索送信により、ピア キャッシュ ソースの現在の境界が決定します。 異なる境界グループにローミングしたクライアントは、ピア キャッシュの目的で、引き続き以前の境界グループのメンバーである場合があります。 この動作により、直接のネットワークの場所にないピア キャッシュ ソースがクライアントに提供されます。 ローミング クライアントをピア キャッシュ ソースとして有効にしないでください。<!--SCCMDocs issue 641-->  

    > [!Important]  
    > バージョン 1806 より、Configuration Manager は、ピア キャッシュ ソースが別の場所にローミングしたとき、決定の効率性が上がります。 この動作により、管理ポイントによって、以前の場所ではなく、新しい場所でピア キャッシュ ソースがコンテンツ ソースとしてクライアントに提供されます。 ピア キャッシュ機能をローミング ピア キャッシュ ソースと共に使用している場合、サイトをバージョン 1806 に更新した後、すべてのピア キャッシュ ソースも最新版のクライアント バージョンに更新してください。 少なくともバージョン 1806 に更新されるまで、管理ポイントのコンテンツの場所一覧にはこれらのピア キャッシュ ソースが含まれません。<!--SCCMDocs issue 850-->  

- 管理ポイントは、コンテンツのダウンロードを試みる前に、ピア キャッシュ ソースがオンラインになっていることを検証します。<!--sms.498675--> この検証はクライアント通知用の "高速チャネル" で行われ、TCP ポート 10123 を使用します。<!--511673-->  

> [!Note]  
> Configuration Manager の新機能を利用するには、最初にクライアントを最新バージョンに更新します。 サイトとコンソールを更新すると Configuration Manager コンソールに新しい機能が表示されますが、クライアントのバージョンも最新になるまでは完全なシナリオは機能しません。  



## <a name="bkmk_settings"></a> ピア キャッシュ クライアントの設定

ピア キャッシュ クライアントの設定について詳しくは、「[クライアント キャッシュ設定](/sccm/core/clients/deploy/about-client-settings#client-cache-settings)」をご覧ください。 

これらの設定の構成について詳しくは、[クライアント設定を構成する方法](/sccm/core/clients/deploy/configure-client-settings)に関するページをご覧ください。

Windows ファイアウォールを使用するピア キャッシュ対応のクライアント上では、Configuration Manager が、クライアント設定で指定されたファイアウォール ポートを構成します。



## <a name="bkmk_parts"></a> 一部ダウンロードのサポート
<!--1357346--> バージョン 1806 以降では、クライアント ピア キャッシュ ソースのコンテンツを分割できます。 これにより、ネットワーク転送が最小限に抑えられ、WAN の使用率が減ります。 管理ポイントでは、コンテンツの各パートをより詳細に追跡することができます。 境界グループごとに同じ内容が複数回ダウンロードされないようにします。 


### <a name="example-scenario"></a>シナリオ例

Contoso には、本社 (HQ) および支社という 2 つの境界グループを持つ 1 つのプライマリ サイトがあります。 2 つの境界グループ間には 30 分のフォールバック リレーションシップがあります。 サイトの管理ポイントと配布ポイントは HQ 境界にのみ存在します。 支社の場所にはローカル配布ポイントはありません。 支社の 4 つのクライアントのうち 2 つは、ピア キャッシュ ソースとして構成されています。 

![シナリオ例で説明されているネットワーク構成の図](media/1357346-peer-cache-source-parts.png)

1. 支社の 4 つのすべてのクライアントを、コンテンツを含む展開の対象とします。 コンテンツは配布ポイントにのみ配布されています。  

2. Client3 と Client4 には、展開するローカル ソースはありません。 管理ポイントは、リモート境界グループにフォールバックするまでクライアントに 30 分待機するよう指示します。  

3. Client1 (PCS1) は、管理ポイントでポリシーを更新する最初のピア キャッシュ ソースです。 このクライアントがピア キャッシュ ソースとして有効になっているため、管理ポイントは、配布ポイントからパート A のダウンロードをすぐに開始するように指示します。  

4. Client2 (PCS2) が管理ポイントに接続するときに、パート A は既に進行中ですが、まだ完了していないため、管理ポイントは、配布ポイントからパート B のダウンロードをすぐに開始するように指示します。  

5. PCS1 はパート A のダウンロードを終了し、すぐに管理ポイントに通知します。 パート B は既に進行中ですが、まだ完了していないため、管理ポイントは、配布ポイントからパート C のダウンロードを開始するように指示します。  

6. PCS2 はパート B のダウンロードを終了し、すぐに管理ポイントに通知します。 管理ポイントは、配布ポイントからパート D のダウンロードを開始するように指示します。  

7. PCS1 はパート C のダウンロードを終了し、すぐに管理ポイントに通知します。 管理ポイントは、リモート配布ポイントから利用可能なパートがなくなったことを通知します。 管理ポイントは、ローカル ピア PCS2 からパート B をダウンロードするように指示します。  

8. このプロセスは、両方のクライアント ピア キャッシュ ソースが互いにすべてのパートを取得するまで続きます。 管理ポイントは、ピア キャッシュ ソースにローカル ピアからパートをダウンロードするよう指示する前に、リモート配布ポイントからのパートに優先順位を付けます。  

9. Client3 は、30 分のフォールバック期間が過ぎた後、ポリシーを更新する最初のクライアントです。 ここで管理ポイントをもう一度確認し、クライアントに新しいローカル ソースを通知します。 WAN 経由で配布ポイントからコンテンツをすべてダウンロードするのではなく、クライアントのいずれかのピア キャッシュ ソースからコンテンツをすべてダウンロードします。 クライアントはローカル ピア ソースに優先順位を付けます。 

> [!Note]  
> クライアントのピア キャッシュ ソースの数がコンテンツ パートの数より大きい場合、管理ポイントは通常のクライアントのようにフォールバックを待機するよう追加のピア キャッシュ ソースに指示します。 


### <a name="configure-partial-download"></a>一部ダウンロードを構成する

1. 通常どおり、[境界グループ](/sccm/core/servers/deploy/configure/boundary-groups)とピア キャッシュ ソースを設定します。  

2. Configuration Manager コンソールで、**[管理]** ワークスペースに移動し、**[サイトの構成]** を展開して **[サイト]** を選択します。 リボンの **[階層設定]** をクリックします。  

3. **[全般]** タブで、**コンテンツを分割するようクライアントのピア キャッシュ ソースを構成する**オプションを有効にします。  

4. コンテンツを含む必要な展開を作成します。  

   > [!Note]  
   > この機能は、必要な展開などを含め、クライアントがバックグラウンドでコンテンツをダウンロードする場合にのみ動作します。 ユーザーがソフトウェア センターで利用可能な展開をインストールする場合など、オンデマンド ダウンロードは、通常どおり動作します。  

コンテンツの分割ダウンロードの処理を確認するには、クライアントのピア キャッシュ ソースの **ContentTransferManager.log** と、管理ポイントの **MP_Location.log** を調べます。  



## <a name="guidance-for-cache-management"></a>キャッシュの管理に関するガイダンス
<!--510645--> ピア キャッシュは構成マネージャー クライアント キャッシュに依存してコンテンツを共有します。 お使いの環境内でのクライアント キャッシュの管理については、次の点を考慮してください。  

- 構成マネージャー クライアント キャッシュは、配布ポイントのコンテンツ ライブラリのようなものではありません。 配布ポイントに配布するコンテンツはユーザーが管理しますが、構成マネージャー クライアントはキャッシュ内のコンテンツを自動的に管理します。 ピア キャッシュ ソースのキャッシュ内のコンテンツを制御するのに役立つ設定と方法があります。 詳しくは、「[Configuration Manager クライアントにクライアントキャッシュを構成する](/sccm/core/clients/manage/manage-clients#BKMK_ClientCache)」をご覧ください。  

- 通常のキャッシュ サイズとメンテナンスが、ピア キャッシュ ソースに適用されます。 詳しくは、「[クライアント キャッシュ サイズの構成](/sccm/core/clients/deploy/about-client-settings#configure-client-cache-size)」をご覧ください。 OS アップグレード パッケージや Windows 10 高速更新プログラム ファイルなどの大きいコンテンツのサイズを検討します。 このコンテンツに必要な量と、ピア キャッシュ ソースで使用可能なディスク領域を比較します。  

- ピア キャッシュ ソース クライアントは、ピアがキャッシュ内のコンテンツをダウンロードするときに、その最終参照時刻を更新します。 クライアントは、キャッシュの自動メンテナンスでこのタイムスタンプを使用して、古いコンテンツから先に削除します。 したがって、ピア キャッシュ クライアントが頻繁にダウンロードするコンテンツがある場合は削除を待つ必要があります。  

- 必要な場合は、OS 展開タスク シーケンスの間に、**SMSTSPreserveContent** 変数を使用してクライアント キャッシュ内のコンテンツを保持します。 詳しくは、「[タスク シーケンス変数](/sccm/osd/understand/task-sequence-variables#SMSTSPreserveContent)」をご覧ください。  

- 必要に応じて、次のソフトウェアを作成するときに、**[クライアント キャッシュの内容を保持する]** オプションを使用します。  
    - アプリケーション
    - パッケージ
    - OS イメージ
    - OS アップグレード パッケージ
    - ブート イメージ



## <a name="monitoring"></a>監視   

クライアントが正常にピア キャッシュの使用を把握しやすいように、**クライアント データ ソース** ダッシュボードを表示します。 詳しくは、「[クライアント データ ソース ダッシュボード](/sccm/core/servers/deploy/configure/monitor-content-you-have-distributed#client-data-sources-dashboard)」をご覧ください。

また、レポートを使用してピア キャッシュの使用状況を表示します。 コンソールで **[監視]** ワークスペースに移動し、**[レポート]** を展開して、**[レポート]** ノードを選択します。 次のレポートの種類はすべて**ソフトウェア配布コンテンツ**です。  

1.  **ピア キャッシュ ソース コンテンツの拒否**:境界グループ内のピア キャッシュ ソースでコンテンツ要求が拒否される頻度。  

    > [!Note]  
    > **既知の問題**<!--486652-->:*MaxCPULoad* や *MaxDiskIO* などの結果にドリルダウンすると、レポートまたは詳細情報が見つからないことを示すエラーが発生する場合があります。 この問題を回避するには、結果を直接表示する他の 2 つのレポートを使ってください。  

2. **条件別のピア キャッシュ ソース コンテンツの拒否**:指定した境界グループまたは拒否の種類について、拒否の詳細を示します。 

    > [!Note]  
    > **既知の問題**<!--486652-->:使用可能なパラメーターから選ぶことができず、代わりに手入力する必要があります。 **ピア キャッシュ ソース コンテンツの拒否**レポートに表示される*境界グループ名*と*拒否の種類*の値を入力します。 たとえば、*拒否の種類*には、*MaxCPULoad* や *MaxDiskIO* などと入力します。  

3. **ピア キャッシュ ソース コンテンツの拒否の詳細**:拒否されたときにクライアントが要求していたコンテンツを表示します。  

    > [!Note]  
    > **既知の問題**<!--486652-->:使用可能なパラメーターから選ぶことができず、代わりに手入力する必要があります。 **[ピア キャッシュ ソース コンテンツの拒否]** レポートに表示されている "*拒否の種類*" の値を入力します。 詳細情報を確認するコンテンツ ソースの "*リソース ID*" を入力します。 
    > 
    > コンテンツ ソースのリソース ID を調べるには:  
    > 
    > 1. **[ピア キャッシュ ソース コンテンツの拒否 (条件別)]** レポートの結果に "*ピア キャッシュ ソース*" として表示されるコンピューター名を確認します。  
    > 
    > 2. **[資産とコンプライアンス]** ワークスペースに移動し、**[デバイス]** ノードを選択して、そのコンピューターの名前を検索します。 [リソース ID] 列の値を使います。  

